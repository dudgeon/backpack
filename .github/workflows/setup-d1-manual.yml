name: Manual D1 Setup

on:
  workflow_dispatch:

jobs:
  setup-d1:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create D1 Database
        id: create_db
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Creating D1 database..."

          response=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/d1/database" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"name":"backpack"}')

          echo "Response: $response"

          # Extract database_id from response
          database_id=$(echo "$response" | jq -r '.result.uuid')

          if [ "$database_id" = "null" ] || [ -z "$database_id" ]; then
            echo "❌ Failed to create D1 database"
            echo "$response" | jq '.'
            exit 1
          fi

          echo "✅ Created D1 database with ID: $database_id"
          echo "database_id=$database_id" >> $GITHUB_OUTPUT

      - name: Update wrangler.jsonc
        run: |
          database_id="${{ steps.create_db.outputs.database_id }}"

          # Update the database_id in wrangler.jsonc
          sed -i "s/placeholder-create-with-wrangler-d1-create/$database_id/g" wrangler.jsonc

          echo "✅ Updated wrangler.jsonc with database ID"
          grep -A 2 "database_id" wrangler.jsonc

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add wrangler.jsonc
          git commit -m "Configure D1 database ID

          Database ID: ${{ steps.create_db.outputs.database_id }}

          [skip ci]"

          git push
