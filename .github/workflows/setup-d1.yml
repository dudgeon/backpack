name: Setup D1 Database

on:
  push:
    branches:
      - 'claude/**'
      - main

jobs:
  setup-d1:
    runs-on: ubuntu-latest
    # Only run if the database_id is still a placeholder
    if: contains(github.event.head_commit.message, 'placeholder') || contains(github.event.head_commit.message, 'Setup D1') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: Check if D1 database needs to be created
        id: check
        run: |
          if grep -q "placeholder-create-with-wrangler-d1-create" wrangler.jsonc; then
            echo "needs_creation=true" >> $GITHUB_OUTPUT
          else
            echo "needs_creation=false" >> $GITHUB_OUTPUT
            echo "✅ D1 database already configured"
          fi

      - name: Create D1 Database
        if: steps.check.outputs.needs_creation == 'true'
        id: create_db
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Creating D1 database..."

          response=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/d1/database" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"name":"backpack"}')

          echo "Response: $response"

          # Extract database_id from response
          database_id=$(echo "$response" | jq -r '.result.uuid')

          if [ "$database_id" = "null" ] || [ -z "$database_id" ]; then
            echo "❌ Failed to create D1 database"
            echo "$response" | jq '.'
            exit 1
          fi

          echo "✅ Created D1 database with ID: $database_id"
          echo "database_id=$database_id" >> $GITHUB_OUTPUT

      - name: Update wrangler.jsonc
        if: steps.check.outputs.needs_creation == 'true'
        run: |
          database_id="${{ steps.create_db.outputs.database_id }}"

          # Update the database_id in wrangler.jsonc
          sed -i "s/placeholder-create-with-wrangler-d1-create/$database_id/g" wrangler.jsonc

          echo "✅ Updated wrangler.jsonc with database ID"
          grep -A 2 "database_id" wrangler.jsonc

      - name: Commit and push changes
        if: steps.check.outputs.needs_creation == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add wrangler.jsonc
          git commit -m "Configure D1 database ID

          Database ID: ${{ steps.create_db.outputs.database_id }}

          [skip ci]" || echo "No changes to commit"

          git push
