name: Deploy via Cloudflare API

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run D1 migrations via API
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Running D1 migrations via Cloudflare API..."

          DATABASE_ID="daea8d97-5310-499e-8993-2844465d466a"

          # Read the migration file
          MIGRATION_SQL=$(cat migrations/0001_initial.sql)

          # Execute migration via API
          response=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/d1/database/${DATABASE_ID}/query" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"sql\":$(echo "$MIGRATION_SQL" | jq -Rs .)}")

          echo "Migration response:"
          echo "$response" | jq '.'

          # Check if successful
          success=$(echo "$response" | jq -r '.success')
          if [ "$success" != "true" ]; then
            echo "❌ Migration failed"
            exit 1
          fi

          echo "✅ Migrations completed"

      - name: Build and deploy Worker via wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Deploying Worker to Cloudflare..."

          # Try wrangler deploy with explicit account ID
          npx wrangler deploy --compatibility-date 2024-01-01

          echo "✅ Deployment completed"
